{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","scriptjs","dateMath","GoogleStackdriverDatasource","instanceSettings","$q","templateSrv","timeSrv","type","name","clientId","jsonData","scopes","join","discoveryDocs","initialized","q","options","initialize","then","Promise","all","targets","map","performTimeSeriesQuery","target","range","response","timeSeries","forEach","series","flatten","responses","filter","data","aliasPattern","alias","metricLabel","getMetricLabel","datapoints","valueKey","valueType","toLowerCase","points","point","push","value","Date","parse","interval","endTime","valueOf","err","JSON","body","console","log","error","query","timeRange","labelQuery","match","params","projectId","view","valuePicker","property","when","text","d","load","gapi","client","init","scope","status","message","title","deferred","defer","resolve","promise","auth2","getAuthInstance","currentUser","get","authInstance","isSignedIn","signIn","user","angular","copy","aggregation","Object","keys","key","pageToken","convertTime","from","to","monitoring","projects","list","nextPageToken","concat","nextResponse","aliasRegex","aliasData","metric","resource","label","replace","g1","matchedValue","date","roundUp","isString","toISOString"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport scriptjs from './libs/script.js';\nimport dateMath from 'app/core/utils/datemath';\n\nexport class GoogleStackdriverDatasource {\n  constructor(instanceSettings, $q, templateSrv, timeSrv) {\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.clientId = instanceSettings.jsonData.clientId;\n    this.scopes = [\n      //'https://www.googleapis.com/auth/cloud-platform',\n      //'https://www.googleapis.com/auth/monitoring',\n      'https://www.googleapis.com/auth/monitoring.read'\n    ].join(' ');\n    this.discoveryDocs = [ \"https://monitoring.googleapis.com/$discovery/rest?version=v3\" ];\n    this.initialized = false;\n    this.q = $q;\n    this.templateSrv = templateSrv;\n    this.timeSrv = timeSrv;\n  }\n\n  query(options) {\n    return this.initialize().then(() => {\n      return Promise.all(options.targets.map(target => {\n        return this.performTimeSeriesQuery(target, options.range).then(response => {\n          response.timeSeries.forEach(series => {\n            series.target = target;\n          });\n          return response;\n        });\n      })).then(responses => {\n        let timeSeries = _.flatten(responses.filter(response => {\n          return !!response.timeSeries;\n        }).map(response => {\n          return response.timeSeries;\n        }));\n        return {\n          data: timeSeries.map(series => {\n            let aliasPattern = '{{resource.type}} - {{metric.type}}';\n            if (series.target.alias) {\n              aliasPattern = series.target.alias;\n            }\n            let metricLabel = this.getMetricLabel(aliasPattern, series);\n\n            let datapoints = [];\n            let valueKey = series.valueType.toLowerCase() + 'Value';\n            for (let point of series.points) {\n              datapoints.push([point.value[valueKey], Date.parse(point.interval.endTime).valueOf()]);\n            }\n            return { target: metricLabel, datapoints: datapoints };\n          })\n        };\n      }, err => {\n        err = JSON.parse(err.body);\n        console.log(err);\n        throw err.error;\n      });\n    });\n  }\n\n  metricFindQuery(query) {\n    let range = this.timeSrv.timeRange();\n    var labelQuery = query.match(/^label_values\\(([^,]+), *([^,]+), *(.*)\\)/);\n    if (labelQuery) {\n      let params = {\n        projectId: labelQuery[1],\n        filter: labelQuery[3],\n        view: 'HEADERS'\n      };\n      return this.performTimeSeriesQuery(params, range).then(response => {\n        let valuePicker = _.property(labelQuery[2]);\n        return this.q.when(response.timeSeries.map(d => {\n          return { text: valuePicker(d) };\n        }));\n      });\n    }\n\n    return this.q.when([]);\n  }\n\n  testDatasource() {\n    return this.load().then(() => {\n      return gapi.client.init({\n        clientId: this.clientId,\n        scope: this.scopes,\n        discoveryDocs: this.discoveryDocs\n      }).then(() => {\n        return { status: 'success', message: 'Data source is working', title: 'Success' };\n      });\n    });\n  }\n\n  load() {\n    let deferred = this.q.defer();\n    scriptjs('https://apis.google.com/js/api.js', () => {\n      gapi.load('client:auth2', () => {\n        return deferred.resolve();\n      });\n    });\n    return deferred.promise;\n  }\n\n  initialize() {\n    if (this.initialized) {\n      return Promise.resolve(gapi.auth2.getAuthInstance().currentUser.get());\n    }\n\n    return this.load().then(() => {\n      return gapi.client.init({\n        clientId: this.clientId,\n        scope: this.scopes,\n        discoveryDocs: this.discoveryDocs\n      }).then(() => {\n        let authInstance = gapi.auth2.getAuthInstance();\n        if (!authInstance) {\n          throw { message: 'failed to initialize' };\n        }\n        let isSignedIn = authInstance.isSignedIn.get();\n        if (isSignedIn) {\n          this.initialized = true;\n          return authInstance.currentUser.get();\n        }\n        return authInstance.signIn().then(user => {\n          this.initialized = true;\n          return user;\n        });\n      }, err => {\n        console.log(err);\n        throw { message: 'failed to initialize' };\n      });\n    });\n  }\n\n  performTimeSeriesQuery(target, range) {\n    target = angular.copy(target);\n    let params = {};\n    params.name = 'projects/' + target.projectId;\n    params.filter = target.filter;\n    if (target.aggregation) {\n      for (let key of Object.keys(target.aggregation)) {\n        params['aggregation.' + key] = target.aggregation[key];\n      }\n    }\n    if (target.pageToken) {\n      params.pageToken = target.pageToken;\n    }\n    params['interval.startTime'] = this.convertTime(range.from, false);\n    params['interval.endTime'] = this.convertTime(range.to, true);\n    return gapi.client.monitoring.projects.timeSeries.list(params).then(response => {\n      response = JSON.parse(response.body);\n      if (!response) {\n        return {};\n      }\n      if (!response.nextPageToken) {\n        return response;\n      }\n      target.pageToken = response.nextPageToken;\n      return this.performTimeSeriesQuery(target, range).then(nextResponse => {\n        response = response.timeSeries.concat(nextResponse.timeSeries);\n        return response;\n      });\n    });\n  }\n\n  getMetricLabel(aliasPattern, series) {\n    let aliasRegex = /\\{\\{(.+?)\\}\\}/g;\n    let aliasData = {\n      metric: series.metric,\n      resource: series.resource\n    };\n    let label = aliasPattern.replace(aliasRegex, (match, g1) => {\n      let matchedValue = _.property(g1)(aliasData);\n      if (matchedValue) {\n        return matchedValue;\n      }\n      return g1;\n    });\n    return label;\n  }\n\n  convertTime(date, roundUp) {\n    if (_.isString(date)) {\n      date = dateMath.parse(date, roundUp);\n    }\n    return date.toISOString();\n  };\n}\n"]}