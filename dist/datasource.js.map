{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","angular","scriptjs","dateMath","GoogleStackdriverDatasource","instanceSettings","$q","templateSrv","timeSrv","type","name","clientId","jsonData","defaultProjectId","scopes","join","discoveryDocs","initialized","q","options","initialize","then","Promise","all","targets","map","target","copy","filter","replace","metricType","scopedVars","performTimeSeriesQuery","response","timeSeries","forEach","series","flatten","responses","data","aliasPattern","alias","metricLabel","getMetricLabel","datapoints","valueKey","valueType","toLowerCase","points","point","push","value","Date","parse","interval","endTime","valueOf","err","JSON","body","console","log","error","query","metricsQuery","match","projectId","params","performMetricDescriptorsQuery","when","metricDescriptors","text","d","labelQuery","targetProperty","view","range","timeRange","valuePicker","property","groupsQuery","performGroupsQuery","group","split","groupMembersQuery","groupId","performGroupsMembersQuery","members","status","message","title","catch","deferred","defer","gapi","load","resolve","promise","auth2","getAuthInstance","currentUser","get","client","init","scope","authInstance","isSignedIn","signIn","user","aggregation","Object","keys","key","isArray","Math","max","intervalMs","pageToken","convertTime","from","to","monitoring","projects","list","nextPageToken","concat","nextResponse","groups","aliasRegex","aliasData","metric","resource","label","g1","matchedValue","date","roundUp","isString","toISOString"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport angular from 'angular';\nimport scriptjs from './libs/script.js';\nimport dateMath from 'app/core/utils/datemath';\n\nexport class GoogleStackdriverDatasource {\n  constructor(instanceSettings, $q, templateSrv, timeSrv) {\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.clientId = instanceSettings.jsonData.clientId;\n    this.defaultProjectId = instanceSettings.jsonData.defaultProjectId;\n    this.scopes = [\n      //'https://www.googleapis.com/auth/cloud-platform',\n      //'https://www.googleapis.com/auth/monitoring',\n      'https://www.googleapis.com/auth/monitoring.read'\n    ].join(' ');\n    this.discoveryDocs = [ \"https://monitoring.googleapis.com/$discovery/rest?version=v3\" ];\n    this.initialized = false;\n    this.q = $q;\n    this.templateSrv = templateSrv;\n    this.timeSrv = timeSrv;\n  }\n\n  query(options) {\n    return this.initialize().then(() => {\n      return Promise.all(options.targets.map(target => {\n        target = angular.copy(target);\n        let filter = 'metric.type = \"' + this.templateSrv.replace(target.metricType, options.scopedVars || {}) + '\"';\n        if (target.filter) {\n          filter += ' AND ' + this.templateSrv.replace(target.filter, options.scopedVars || {});\n        }\n        target.filter = filter;\n        return this.performTimeSeriesQuery(target, options).then(response => {\n          response.timeSeries.forEach(series => {\n            series.target = target;\n          });\n          return response;\n        });\n      })).then(responses => {\n        let timeSeries = _.flatten(responses.filter(response => {\n          return !!response.timeSeries;\n        }).map(response => {\n          return response.timeSeries;\n        }));\n        return {\n          data: timeSeries.map(series => {\n            let aliasPattern = '{{resource.type}} - {{metric.type}}';\n            if (series.target.alias) {\n              aliasPattern = series.target.alias;\n            }\n            let metricLabel = this.getMetricLabel(aliasPattern, series);\n\n            let datapoints = [];\n            let valueKey = series.valueType.toLowerCase() + 'Value';\n            for (let point of series.points) {\n              datapoints.push([point.value[valueKey], Date.parse(point.interval.endTime).valueOf()]);\n            }\n            return { target: metricLabel, datapoints: datapoints };\n          })\n        };\n      }, err => {\n        err = JSON.parse(err.body);\n        console.log(err);\n        throw err.error;\n      });\n    });\n  }\n\n  metricFindQuery(query) {\n    let metricsQuery = query.match(/^metrics\\((([^,]+), *)?(.*)\\)/);\n    if (metricsQuery) {\n      let projectId = metricsQuery[2] || this.defaultProjectId;\n      let filter = metricsQuery[3];\n      let params = {\n        projectId: projectId,\n        filter: filter\n      };\n      return this.performMetricDescriptorsQuery(params, {}).then(response => {\n        return this.q.when(response.metricDescriptors.map(d => {\n          return { text: d.type };\n        }));\n      });\n    }\n\n    let labelQuery = query.match(/^label_values\\((([^,]+), *)?([^,]+), *(.*)\\)/);\n    if (labelQuery) {\n      let projectId = labelQuery[2] || this.defaultProjectId;\n      let targetProperty = labelQuery[3];\n      let filter = labelQuery[4];\n      let params = {\n        projectId: projectId,\n        filter: filter,\n        view: 'HEADERS'\n      };\n      return this.performTimeSeriesQuery(params, { range: this.timeSrv.timeRange() }).then(response => {\n        let valuePicker = _.property(targetProperty);\n        return this.q.when(response.timeSeries.map(d => {\n          return { text: valuePicker(d) };\n        }));\n      });\n    }\n\n    let groupsQuery = query.match(/^groups\\(([^,]+)?\\)/);\n    if (groupsQuery) {\n      let projectId = groupsQuery[1] || this.defaultProjectId;\n      let params = {\n        projectId: projectId\n      };\n      return this.performGroupsQuery(params, {}).then(response => {\n        return this.q.when(response.group.map(d => {\n          return {\n            //text: d.displayName\n            text: d.name.split('/')[3]\n          };\n        }));\n      });\n    }\n\n    let groupMembersQuery = query.match(/^group_members\\((([^,]+), *)?([^,]+), *([^,]+), *(.*)\\)/);\n    if (groupMembersQuery) {\n      let projectId = groupMembersQuery[2] || this.defaultProjectId;\n      let groupId = groupMembersQuery[3];\n      let targetProperty = groupMembersQuery[4];\n      let filter = groupMembersQuery[5];\n      let params = {\n        projectId: projectId,\n        groupId: groupId,\n        filter: filter\n      };\n      return this.performGroupsMembersQuery(params, { range: this.timeSrv.timeRange() }).then(response => {\n        let valuePicker = _.property(targetProperty);\n        return this.q.when(response.members.map(d => {\n          return { text: valuePicker(d) };\n        }));\n      });\n    }\n\n    return this.q.when([]);\n  }\n\n  testDatasource() {\n    return this.initialize().then(() => {\n      return { status: 'success', message: 'Data source is working', title: 'Success' };\n    }).catch(err => {\n      console.log(err);\n      return { status: \"error\", message: err.message, title: \"Error\" };\n    });\n  }\n\n  load() {\n    let deferred = this.q.defer();\n    scriptjs('https://apis.google.com/js/api.js', () => {\n      gapi.load('client:auth2', () => {\n        return deferred.resolve();\n      });\n    });\n    return deferred.promise;\n  }\n\n  initialize() {\n    if (this.initialized) {\n      return Promise.resolve(gapi.auth2.getAuthInstance().currentUser.get());\n    }\n\n    return this.load().then(() => {\n      return gapi.client.init({\n        clientId: this.clientId,\n        scope: this.scopes,\n        discoveryDocs: this.discoveryDocs\n      }).then(() => {\n        let authInstance = gapi.auth2.getAuthInstance();\n        if (!authInstance) {\n          throw { message: 'failed to initialize' };\n        }\n        let isSignedIn = authInstance.isSignedIn.get();\n        if (isSignedIn) {\n          this.initialized = true;\n          return authInstance.currentUser.get();\n        }\n        return authInstance.signIn().then(user => {\n          this.initialized = true;\n          return user;\n        });\n      }, err => {\n        console.log(err);\n        throw { message: 'failed to initialize' };\n      });\n    });\n  }\n\n  performTimeSeriesQuery(target, options) {\n    target = angular.copy(target);\n    let params = {};\n    params.name = this.templateSrv.replace('projects/' + (target.projectId || this.defaultProjectId), options.scopedVars || {});\n    params.filter = this.templateSrv.replace(target.filter, options.scopedVars || {});\n    if (target.aggregation) {\n      for (let key of Object.keys(target.aggregation)) {\n        if (_.isArray(target.aggregation[key])) {\n          params['aggregation.' + key] = target.aggregation[key].map(aggregation => {\n            return this.templateSrv.replace(aggregation, options.scopedVars || {});\n          });\n        } else if (target.aggregation[key] !== '') {\n          params['aggregation.' + key] = this.templateSrv.replace(target.aggregation[key], options.scopedVars || {});\n        }\n      }\n      // auto period\n      if (params['aggregation.perSeriesAligner'] !== 'ALIGN_NONE' && !params['aggregation.alignmentPeriod']) {\n        params['aggregation.alignmentPeriod'] = Math.max((options.intervalMs / 1000), 60) + 's';\n      }\n    }\n    if (target.view) {\n      params.view = target.view;\n    }\n    if (target.pageToken) {\n      params.pageToken = target.pageToken;\n    }\n    params['interval.startTime'] = this.convertTime(options.range.from, false);\n    params['interval.endTime'] = this.convertTime(options.range.to, true);\n    return gapi.client.monitoring.projects.timeSeries.list(params).then(response => {\n      response = JSON.parse(response.body);\n      if (!response.timeSeries) {\n        return { timeSeries: [] };\n      }\n      if (!response.nextPageToken) {\n        return response;\n      }\n      target.pageToken = response.nextPageToken;\n      return this.performTimeSeriesQuery(target, options).then(nextResponse => {\n        response = response.timeSeries.concat(nextResponse.timeSeries);\n        return response;\n      });\n    });\n  }\n\n  performMetricDescriptorsQuery(target, options) {\n    target = angular.copy(target);\n    let params = {};\n    params.name = this.templateSrv.replace('projects/' + (target.projectId || this.defaultProjectId), options.scopedVars || {});\n    params.filter = this.templateSrv.replace(target.filter, options.scopedVars || {});\n    if (target.pageToken) {\n      params.pageToken = target.pageToken;\n    }\n    return gapi.client.monitoring.projects.metricDescriptors.list(params).then(response => {\n      response = JSON.parse(response.body);\n      if (!response.metricDescriptors) {\n        return { metricDescriptors: [] };\n      }\n      if (!response.nextPageToken) {\n        return response;\n      }\n      target.pageToken = response.nextPageToken;\n      return this.performMetricDescriptorsQuery(target, options).then(nextResponse => {\n        response = response.metricDescriptors.concat(nextResponse.metricDescriptors);\n        return response;\n      });\n    });\n  }\n\n  performGroupsQuery(target, options) {\n    target = angular.copy(target);\n    let params = {};\n    params.name = this.templateSrv.replace('projects/' + (target.projectId || this.defaultProjectId), options.scopedVars || {});\n    if (target.pageToken) {\n      params.pageToken = target.pageToken;\n    }\n    return gapi.client.monitoring.projects.groups.list(params).then(response => {\n      response = JSON.parse(response.body);\n      if (!response.group) {\n        return { group: [] };\n      }\n      if (!response.nextPageToken) {\n        return response;\n      }\n      target.pageToken = response.nextPageToken;\n      return this.performGroupsQuery(target, options).then(nextResponse => {\n        response = response.group.concat(nextResponse.group);\n        return response;\n      });\n    });\n  }\n\n  performGroupsMembersQuery(target, options) {\n    target = angular.copy(target);\n    let params = {};\n    params.name = this.templateSrv.replace('projects/'\n     + (target.projectId || this.defaultProjectId)\n     + '/groups/'\n     + target.groupId, options.scopedVars || {});\n    params.filter = this.templateSrv.replace(target.filter, options.scopedVars || {});\n    if (target.pageToken) {\n      params.pageToken = target.pageToken;\n    }\n    params['interval.startTime'] = this.convertTime(options.range.from, false);\n    params['interval.endTime'] = this.convertTime(options.range.to, true);\n    return gapi.client.monitoring.projects.groups.members.list(params).then(response => {\n      response = JSON.parse(response.body);\n      if (!response.members) {\n        return { members: [] };\n      }\n      if (!response.nextPageToken) {\n        return response;\n      }\n      target.pageToken = response.nextPageToken;\n      return this.performGroupsMembersQuery(target, options).then(nextResponse => {\n        response = response.members.concat(nextResponse.members);\n        return response;\n      });\n    });\n  }\n\n  getMetricLabel(aliasPattern, series) {\n    let aliasRegex = /\\{\\{(.+?)\\}\\}/g;\n    let aliasData = {\n      metric: series.metric,\n      resource: series.resource\n    };\n    let label = aliasPattern.replace(aliasRegex, (match, g1) => {\n      let matchedValue = _.property(g1)(aliasData);\n      if (matchedValue) {\n        return matchedValue;\n      }\n      return g1;\n    });\n    return label;\n  }\n\n  convertTime(date, roundUp) {\n    if (_.isString(date)) {\n      date = dateMath.parse(date, roundUp);\n    }\n    return date.toISOString();\n  };\n}\n"]}